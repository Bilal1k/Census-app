library(sf)
library(cancensus)
library(tidyverse)
library(geojsonsf)
library(shinyjs)
library(readr)


options(cancensus.api_key = "CensusMapper_2917694b4ae879aca29dd2ce62134969")

# List regions
regions <- list_census_regions('CA16')

# Filter major metro areas
CMAs <- regions$name[regions$level == "CMA" &
                       regions$pop > 900000]

# get geocodes for CMAs
CMA_codes <- regions$region[regions$name %in% CMAs &
                              regions$level == "CMA"]

table <- tibble::tibble("CMA" = CMAs, "GeoID" =  CMA_codes)

# List census vector "col names"
vec <- list_census_vectors("CA16")

# Choose relevant vector names
vec_mother_tongue <- 
  vec$vector[str_detect(vec$details,
                        pattern =
                          "Mother tongue") & 
               vec$type == "Total" & !is.na(vec$vector)]

vec_POB <- vec$vector[str_detect(vec$details,
                                 pattern =
                                   "Selected places of birth") & 
                        vec$type == "Total" & !is.na(vec$vector)]


vec_vis_minor <- vec$vector[str_detect(vec$details,
                                       pattern =  "Visible minority") & 
                              vec$type == "Total" & !is.na(vec$vector)]

vec_ethnic <- vec$vector[str_detect(vec$details,
                                    pattern =  "Ethnic origin") & 
                           vec$type == "Total" & !is.na(vec$vector)]

# Get all relevant data from census 
# "doesn't work due to API daily and monthly limits"
data_Montreal <- get_census(dataset='CA16', regions=list(CMA=table$GeoID[table$CMA == "MontrÃ©al"]),
  vectors = c(vec_vis_minor,vec_POB,
  vec_ethnic,vec_mother_tongue),
  level="CT", use_cache = TRUE, geo_format = "sf")
data_Montreal <- data
#####################################################################


# Backup raw data , comment to save backup from runs
# backup_minor <- minor_data_mont
minor_data_mont <- data_Montreal[,c(1:13,15:28)]

# small DAs with no data has NA values, change to 0.
minor_data_mont[is.na(minor_data_mont)] <- 0

# clean col names "use each countries name as the 
# col name and shorten total name.
clean_census <- function(x){
  c <- str_split(x, pattern = ": ", simplify = TRUE)[,2]
  return(c)
}


minor_data_mont[,str_detect(names(st_drop_geometry(minor_data_mont)),pattern = "Total -")]  <- NULL
t_ind <- which(str_detect(names(st_drop_geometry(minor_data_mont)),pattern = "Total"))
minor_data_mont$Total <- st_drop_geometry(minor_data_mont)[,t_ind]
minor_data_mont[,t_ind] <- NULL
minor_data_mont <- rename_with(minor_data_mont,clean_census, starts_with("V_CA16"))


# make a list of minority names
minor_nm_mont <- names(st_drop_geometry(
  minor_data_mont)[,14:ncol(st_drop_geometry(minor_data_mont))])


# Calculate percentages, remove NA generated by DAs with zero population
percent <- function(x){
  perc <- round(x*100/minor_data_mont$Population, digits = 2)
  return(perc)
}


minor_data_mont <- minor_data_mont %>%
  mutate_at(minor_nm_mont, percent)

minor_data_mont[is.na(minor_data_mont)] <- 0


# save spatial features to H.D.D as shape file, avoid pulling data multiple 
# times, col names will change due to shape file name length and capitalization
# rules.

minor_df_mont <- st_drop_geometry(minor_data_mont)

Mont_CT_geom <- st_geometry(minor_data_mont)

saveRDS(minor_df, file = "minor_df_mont.rds")
saveRDS(minor_nm_mont, file = "minor_nm_mont.rds")
st_write(Mont_CT_geom,"Mont_CT_geom.shp", append  = FALSE)

##################################################################################


# Backup raw data , quote to save backup from runs
# POB_backup <- POB_data
POB_data_mont <- data[,c(1:13,30:150)]

# small DAs with no data has NA values, change to 0.
POB_data_mont[is.na(POB_data_mont)] <- 0


# split data into immigrants and recent immigrants
POB_data_mont_recent <- POB_data_mont %>% select(-c(14:73))


POB_data_mont <- POB_data_mont %>% select(-c(74:134))

# clean col names "use each countries name as the
# col name and shorten total name.

POB_data_mont <- rename_with(POB_data_mont,clean_census, starts_with("V_CA16"))
t_ind <- which(str_detect(names(st_drop_geometry(POB_data_mont)),pattern = "Total"))
POB_data_mont$Total <- st_drop_geometry(POB_data_mont)[,t_ind]
POB_data_mont[,t_ind] <- NULL

POB_data_mont_recent <- rename_with(POB_data_mont_recent,clean_census, starts_with("V_CA16"))
t_ind <- which(str_detect(names(st_drop_geometry(POB_data_mont_recent)),pattern = "Total"))
POB_data_mont_recent$Total <- st_drop_geometry(POB_data_mont_recent)[,t_ind]
POB_data_mont_recent[,t_ind] <- NULL

# make a list of country names
con_nm_mont <- names(st_drop_geometry(
  POB_data_mont)[,14:ncol(st_drop_geometry(POB_data_mont))])

con_nm_mont_recent <- 
  names(st_drop_geometry(
    POB_data_mont_recent)[,14:ncol(st_drop_geometry(POB_data_mont_recent))])

# Calculate percentages, remove NA generated by DAs with zero population
percent <- function(x){
  perc <- round(x*100/POB_data_mont$Population, digits = 2)
  return(perc)
}

POB_data_mont <- POB_data_mont %>%
  mutate_at(con_nm_mont, percent)

POB_data_mont_recent <- POB_data_mont_recent %>%
  mutate_at(con_nm_mont_recent, percent)

POB_data_mont[is.na(POB_data_mont)] <- 0
POB_data_mont_recent[is.na(POB_data_mont_recent)] <- 0



# remove half of data, the lower half based on mean of pop in CTs
m <- median(max.col(st_drop_geometry(POB_data_mont)[,con_nm_mont]))
ind <- names(which(max.col(st_drop_geometry(POB_data_mont)[,con_nm_mont]) < m))
POB_data_mont[,ind] <- NULL

m <- median(max.col(st_drop_geometry(POB_data_mont_recent)[,con_nm_mont_recent]))
ind <- names(which(max.col(st_drop_geometry(POB_data_mont_recent)[,con_nm_mont_recent]) < m))
POB_data_mont_recent[,ind] <- NULL

con_nm_mont <- names(st_drop_geometry(
  POB_data_mont)[,14:ncol(st_drop_geometry(POB_data_mont))])

con_nm_mont_recent <-
  names(st_drop_geometry(
    POB_data_mont_recent)[,14:ncol(st_drop_geometry(POB_data_mont_recent))])


# save spatial features to H.D.D as shape file, avoid pulling data multiple 
# times, col names will change due to shape file name length and capitalization
# rules. it is better to save them separately as a data frame, merge later after loading.

POB_df_mont <- st_drop_geometry(POB_data_mont)
saveRDS(POB_df, file = "POB_df_mont.rds")
saveRDS(con_nm_mont, file = "con_nm_mont.rds")

POB_df_mont_recent <- st_drop_geometry(POB_data_mont_recent)
saveRDS(POB_df_mont_recent, file = "POB_df_mont_rec.rds")
saveRDS(con_nm_mont_recent, file = "con_nm_mont_rec.rds")

######################################################################################################################
# get mother tongue data
lang_data_mont <- data[,c(1:13,429:697)]

# small CTs with no data has NA values, change to 0.
lang_data_mont[is.na(lang_data_mont)] <- 0


# clean col names "use each countries name as the
# col name and shorten total name.

lang_data_mont <- rename_with(lang_data_mont,clean_census, starts_with("V_CA16"))
t_ind <- which(str_detect(names(st_drop_geometry(lang_data_mont)),pattern = "Total"))
lang_data_mont$Total <- st_drop_geometry(lang_data_mont)[,t_ind]
lang_data_mont[,t_ind] <- NULL


# make a list of country names
lang_nm_mont <- names(st_drop_geometry(
  lang_data_mont)[,16:ncol(st_drop_geometry(lang_data_mont))])

# Calculate percentages, remove NA generated by DAs with zero population
percent <- function(x){
  perc <- round(x*100/lang_data_mont$Population, digits = 2)
  return(perc)
}

lang_data_mont <- lang_data_mont %>%
  mutate_at(lang_nm_mont, percent)

lang_data_mont[is.na(lang_data_mont)] <- 0


# remove half of data, the lower half based on max percentage of pop in CTs
hist(apply(st_drop_geometry(lang_data_mont)[,lang_nm_mont], 2, max), breaks = 100)
summary(apply(st_drop_geometry(lang_data_mont)[,lang_nm_mont], 2, max))

m <- median(apply(st_drop_geometry(lang_data_mont)[,lang_nm_mont], 2, max))
ind <- names(which(apply(st_drop_geometry(lang_data_mont)[,lang_nm_mont], 2, max) < m))
lang_data_mont[,ind] <- NULL

lang_nm_mont <- names(st_drop_geometry(
  lang_data_mont)[,16:ncol(st_drop_geometry(lang_data_mont))])

# save list and df

lang_df_mont <- st_drop_geometry(lang_data_mont)
saveRDS(lang_df_mont, file = "lang_df_mont.rds")
saveRDS(lang_nm_mont, file = "lang_nm_mont.rds")

######################################################################################################################

# get ethnic data

ethn_data_mont <- data[,c(1:13,29,151:428)]

# small DAs with no data has NA values, change to 0.
ethn_data_mont[is.na(ethn_data_mont)] <- 0


# clean col names "use each countries name as the
# col name and shorten total name.
sum(str_detect(names(ethn_data_mont), pattern = "Total"))

ethn_data_mont <- rename_with(ethn_data_mont,clean_census, starts_with("V_CA16"))
t_ind <- which(str_detect(names(st_drop_geometry(ethn_data_mont)),pattern = "Total"))
ethn_data_mont$Total <- st_drop_geometry(ethn_data_mont)[,t_ind]
ethn_data_mont[,t_ind] <- NULL


# make a list of country names
ethn_nm_mont <- names(st_drop_geometry(
  ethn_data_mont)[,14:ncol(st_drop_geometry(ethn_data_mont))])

# Calculate percentages, remove NA generated by CTs with zero population
percent <- function(x){
  perc <- round(x*100/ethn_data_mont$Population, digits = 2)
  return(perc)
}

ethn_data_mont <- ethn_data_mont %>%
  mutate_at(ethn_nm_mont, percent)

ethn_data_mont[is.na(ethn_data_mont)] <- 0


# remove half of data, the lower half based on max percentage of pop in CTs
hist(apply(st_drop_geometry(ethn_data_mont)[,ethn_nm_mont], 2, max), breaks = 100)
summary(apply(st_drop_geometry(ethn_data_mont)[,ethn_nm_mont], 2, max))

m <- median(apply(st_drop_geometry(ethn_data_mont)[,ethn_nm_mont], 2, max))
ind <- names(which(apply(st_drop_geometry(ethn_data_mont)[,ethn_nm_mont], 2, max) < m))
ethn_data_mont[,ind] <- NULL

ethn_nm_mont <- names(st_drop_geometry(
  ethn_data_mont)[,14:ncol(st_drop_geometry(ethn_data_mont))])

# save list and df

ethn_df_mont <- st_drop_geometry(ethn_data_mont)
saveRDS(ethn_df_mont, file = "ethn_df_mont.rds")
saveRDS(ethn_nm_mont, file = "ethn_nm_mont.rds")
